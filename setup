#!/bin/bash

set -euo pipefail

# Install fish shell if not present, then set as default
if ! command -v fish >/dev/null; then
  if command -v apt-get >/dev/null; then
    sudo apt-get update -y
    sudo apt-get install -y fish
  elif command -v dnf >/dev/null; then
    sudo dnf install -y fish
  elif command -v pacman >/dev/null; then
    sudo pacman -Sy --noconfirm fish
  else
    echo "Package manager not recognized; install fish manually" >&2
  fi
fi
if command -v fish >/dev/null; then
  sudo chsh -s "$(command -v fish)" "$USER"
fi

# (Legacy) Setting Up zsh if desired and available
# Keeping original logic commented for reference
# if command -v zsh >/dev/null; then
#   sudo chsh -s $(command -v zsh) $USER
# fi

# Bootstrap chezmoi if missing
if ! command -v chezmoi >/dev/null; then
  sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply git@github.com:fcosanabria/dotfiles-refactor.git
fi

# Ensure starship installed (prefer mise)
if command -v mise >/dev/null; then
  ~/.local/bin/mise install starship >/dev/null 2>&1 || true # starship tool install
fi

if ! command -v starship >/dev/null; then
  # Fallback manual install to ~/.local/bin
  echo "Installing starship fallback..." >&2
  curl -fsSL https://starship.rs/install.sh -o /tmp/starship_install.sh
  chmod +x /tmp/starship_install.sh
  /tmp/starship_install.sh -y -b "$HOME/.local/bin"
fi

if command -v starship >/dev/null; then
  echo "Starship installed at $(command -v starship)"
else
  echo "WARNING: starship not installed" >&2
fi

# Initial configuration placeholders for starship (no prompt theming modifications here)
STARSHIP_CONFIG_DIR="$HOME/.config"
mkdir -p "$STARSHIP_CONFIG_DIR" || true
# Do not overwrite existing starship.toml
if [ ! -f "$STARSHIP_CONFIG_DIR/starship.toml" ]; then
  cat > "$STARSHIP_CONFIG_DIR/starship.toml" <<'EOF'
# Initial minimal starship configuration (generated by setup). Customize as needed.
add_newline = false
# (Prompt theming intentionally minimal per instructions.)
EOF
fi

exit 0
