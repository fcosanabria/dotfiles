#!/bin/bash

set -euo pipefail

# Install fish shell if not present, then set as default
if ! command -v fish >/dev/null; then
  if command -v apt-get >/dev/null; then
    sudo apt-get update -y
    sudo apt-get install -y fish
  elif command -v dnf >/dev/null; then
    sudo dnf install -y fish
  elif command -v pacman >/dev/null; then
    sudo pacman -Sy --noconfirm fish
  else
    echo "Package manager not recognized; install fish manually" >&2
  fi
fi
if command -v fish >/dev/null; then
  sudo chsh -s "$(command -v fish)" "$USER"
fi

# Bootstrap chezmoi if missing
if ! command -v chezmoi >/dev/null; then
  sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply git@github.com:fcosanabria/dotfiles-refactor.git
fi

# Install starship via mise (added to mise config)
if ! command -v starship >/dev/null; then
  if command -v mise >/dev/null; then
    mise install starship || { echo "Failed to install starship via mise" >&2; }
  else
    echo "mise not available yet; will be installed by chezmoi bootstrap if configured" >&2
  fi
fi

exit 0
