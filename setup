#!/bin/bash

set -euo pipefail

# Install fish shell if not present, then set as default
if ! command -v fish >/dev/null; then
  if command -v apt-get >/dev/null; then
    sudo apt-get update -y
    sudo apt-get install -y fish
  elif command -v dnf >/dev/null; then
    sudo dnf install -y fish
  elif command -v pacman >/dev/null; then
    sudo pacman -Sy --noconfirm fish
  else
    echo "Package manager not recognized; install fish manually" >&2
  fi
fi
if command -v fish >/dev/null; then
  sudo chsh -s "$(command -v fish)" "$USER"
fi

# (Legacy) Setting Up zsh if desired and available
# Keeping original logic commented for reference
# if command -v zsh >/dev/null; then
#   sudo chsh -s $(command -v zsh) $USER
# fi

# Bootstrap chezmoi if missing
if ! command -v chezmoi >/dev/null; then
  sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply git@github.com:fcosanabria/dotfiles-refactor.git
fi

# Install starship using apt when available (no mise usage per request)
if ! command -v starship >/dev/null; then
  if command -v apt-get >/dev/null; then
    sudo apt-get update -y
    sudo apt-get install -y curl ca-certificates gnupg 2>/dev/null || true
    # Use official install script to place binary under ~/.local/bin (avoids older repo versions)
    curl -fsSL https://starship.rs/install.sh -o /tmp/starship_install.sh
    chmod +x /tmp/starship_install.sh
    /tmp/starship_install.sh -y -b "$HOME/.local/bin"
  else
    echo "apt-get not available; starship install skipped (no mise allowed)." >&2
  fi
fi

if command -v starship >/dev/null; then
  echo "Starship installed at $(command -v starship)"
else
  echo "WARNING: starship not installed" >&2
fi

# Initial configuration placeholders for starship (no prompt theming modifications here)
STARSHIP_CONFIG_DIR="$HOME/.config"
mkdir -p "$STARSHIP_CONFIG_DIR" || true
if [ ! -f "$STARSHIP_CONFIG_DIR/starship.toml" ]; then
  cat > "$STARSHIP_CONFIG_DIR/starship.toml" <<'EOF'
# Initial minimal starship configuration (generated by setup). Customize as needed.
add_newline = false
# (Prompt theming intentionally minimal per instructions.)
EOF
fi

# Placeholder fish config to enable future starship init (prompt init not added now)
FISH_CONFIG_DIR="$HOME/.config/fish"
mkdir -p "$FISH_CONFIG_DIR" || true
if [ ! -f "$FISH_CONFIG_DIR/config.fish" ]; then
  cat > "$FISH_CONFIG_DIR/config.fish" <<'EOF'
# Placeholder config.fish generated by setup.
# Add: starship init fish | source   (when prompt theming desired)
EOF
fi

exit 0
